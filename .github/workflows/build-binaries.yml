name: Build binaries

on:
  workflow_dispatch:

  push:
    branches: [ "main", "master" ]
    tags:
      - "v*.*.*"
  pull_request:
    branches: [ "main", "master" ]

permissions:
  contents: read
  packages: write

jobs:
  build:
    environment: secrets
    name: Build mako binaries
    runs-on: bas-build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init submodules
        run: |
          git submodule update --init --recursive

      - name: Set up tags
        id: meta
        run: |
          SHA_TAG=${GITHUB_SHA::7}
          VERSION=$(make mako-version)
          echo "MAKO_VERSION=$VERSION"
          echo "sha_tag=$SHA_TAG" >> "$GITHUB_OUTPUT"
          echo "mako_version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Build binaries
        run: |
          make all

      - name: Build debian package
        run: |
          make mako-deb

      - name: Store build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mako.ubuntu
          if-no-files-found: error
          path: |
            BAS/mako
            BAS/mako.zip
            mako-*.deb

      - name: Prepare registry auth for Kaniko
        run: |
          mkdir -p "${RUNNER_TEMP}/kaniko"
          CONFIG="${RUNNER_TEMP}/kaniko/config.json"
          # Determine which credentials to use
          # Docker Hub requires this exact auth host
          # Write docker config

          if [[ -z "${DOCKER_REGISTRY_PASSWORD}" ]]; then
            echo "DOCKER_REGISTRY_PASSWORD empty!"
            exit 1
          fi
          if [[ -z "${DOCKER_REGISTRY_USER}" ]]; then
            echo "DOCKER_REGISTRY_USER empty!"
            exit 1
          fi
          if [[ -z "${DOCKER_REGISTRY_HOST}" ]]; then
            echo "DOCKER_REGISTRY_HOST empty!"
            exit 1
          fi
          
          cat > "$CONFIG" <<EOF
          {
            "auths": {
              "${DOCKER_REGISTRY_HOST}": {
                "username": "${DOCKER_REGISTRY_USER}",
                "password": "${DOCKER_REGISTRY_PASSWORD}"
              }
            }
          }
          EOF
        env:
          DOCKER_REGISTRY_PASSWORD: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}
          DOCKER_REGISTRY_USER: ${{ secrets.DOCKER_REGISTRY_USER }}
          DOCKER_REGISTRY_HOST: ${{ vars.DOCKER_REGISTRY_HOST }}

      - name: Compute destinations and cache repo
        id: dest
        shell: bash
        run: |

          if [[ -z "${DOCKER_REGISTRY_HOST}" ]]; then
            echo "DOCKER_REGISTRY_HOST empty!"
            exit 1
          fi
          if [[ -z "${DOCKER_REGISTRY_PROJECT}" ]]; then
            echo "DOCKER_REGISTRY_PROJECT empty!"
            exit 1
          fi
          if [[ -z "${DOCKER_IMAGE_NAME}" ]]; then
            echo "DOCKER_IMAGE_NAME empty!"
            exit 1
          fi

          IMAGE="${DOCKER_REGISTRY_HOST}/${DOCKER_REGISTRY_PROJECT}/${DOCKER_IMAGE_NAME}:${{ steps.meta.outputs.mako_version }}"
          if [[ "${{ steps.meta.branch }}" != "main" ]]; then
            # branch is not main, add sha tag
            IMAGE="${IMAGE}-${{ steps.meta.outputs.sha_tag }}"
            DESTS="--destination ${IMAGE}"
          else
            DESTS="--destination ${IMAGE} --destination ${IMAGE}-${{ steps.meta.outputs.sha_tag }}"
          fi

          echo "dests=$DESTS" >> "$GITHUB_OUTPUT"
          # cache repo alongside image (suffix -cache)
          echo "cache_repo=${IMAGE}-cache" >> "$GITHUB_OUTPUT"
          echo "image=${IMAGE}" >> "$GITHUB_OUTPUT"
        env:
          DOCKER_REGISTRY_HOST: ${{ vars.DOCKER_REGISTRY_HOST }}
          DOCKER_REGISTRY_PROJECT: ${{ vars.DOCKER_REGISTRY_PROJECT }}
          DOCKER_IMAGE_NAME: ${{ vars.DOCKER_IMAGE_NAME }}

      - name: Kaniko build (PR - no push)
        if: github.event_name == 'pull_request'
        run: |
          docker run --rm \
            -v "${{ github.workspace }}":/workspace \
            -v "${RUNNER_TEMP}/kaniko":/kaniko/.docker \
            -e DOCKER_CONFIG=/kaniko/.docker \
            gcr.io/kaniko-project/executor:latest \
            --dockerfile /workspace/Dockerfile \
            --context dir:///workspace/BAS \
            --no-push \
            --verbosity info \
            --cache=true \
            --cache-ttl 168h \
            --cache-repo "${{ steps.dest.outputs.cache_repo }}"

      - name: Kaniko build and push
        if: github.event_name != 'pull_request'
        run: |
          docker run --rm \
            -v "${{ github.workspace }}":/workspace \
            -v "${RUNNER_TEMP}/kaniko":/kaniko/.docker \
            -e DOCKER_CONFIG=/kaniko/.docker \
            gcr.io/kaniko-project/executor:latest \
            --dockerfile /workspace/Dockerfile \
            --context dir:///workspace/BAS \
            --verbosity info \
            --cache=true \
            --cache-ttl 168h \
            --cache-repo "${{ steps.dest.outputs.cache_repo }}" \
            ${{ steps.dest.outputs.dests }}

      - name: Summary
        if: always()
        run: |
          echo "### Docker Image" >> "$GITHUB_STEP_SUMMARY"
          echo "\`${{ steps.dest.outputs.image }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Pull with:" >> "$GITHUB_STEP_SUMMARY"
          echo "\`docker pull ${{ steps.dest.outputs.image }}\`" >> "$GITHUB_STEP_SUMMARY"
